# Laravelテストコード設計ルール

## 目次

1. [基本構成](#基本構成)
2. [テストの種類](#テストの種類)
3. [テストの命名規則](#テストの命名規則)
4. [テストの実装ルール](#テストの実装ルール)
5. [テストデータの準備](#テストデータの準備)
6. [アサーション](#アサーション)
7. [テストの実行方法](#テストの実行方法)
8. [CI/CDとの統合](#cicdとの統合)

## 基本構成

プロジェクトのテストは `src/tests` ディレクトリに配置され、以下の構成になっています：

```
tests/
├── Feature/                  # 機能テスト（APIエンドポイントやミドルウェアなど）
│   ├── Auth/                 # 認証関連の機能テスト
│   │   ├── Login/            # ログイン機能テスト
│   │   └── Register/         # 登録機能テスト
│   ├── Api/                  # API関連の機能テスト
│   │   ├── v1/               # APIバージョン1のテスト
│   │   └── v2/               # APIバージョン2のテスト
│   └── Http/                 # HTTPリクエスト関連のテスト
│       ├── Controllers/      # コントローラーのテスト
│       └── Middleware/       # ミドルウェアのテスト
├── Unit/                     # ユニットテスト（個別のクラスや関数）
│   ├── Models/               # モデルのテスト
│   ├── Repositories/         # リポジトリのテスト
│   ├── Requests/             # フォームリクエストのバリデーションテスト
│   ├── Services/             # サービスクラスのテスト
│   └── UseCases/             # ユースケースのテスト
│       ├── Auth/             # 認証関連のユースケーステスト
│       └── User/             # ユーザー関連のユースケーステスト
├── Integration/              # 統合テスト（複数のコンポーネントの連携テスト）
│   ├── Database/             # データベース連携のテスト
│   └── Services/             # 複数サービス間の連携テスト
├── Support/                  # テストサポートクラス
│   ├── Factories/            # テスト用ファクトリ
│   ├── Helpers/              # テスト用ヘルパー関数
│   └── Traits/               # テスト用トレイト
├── TestCase.php              # すべてのテストの基底クラス
└── CreatesApplication.php    # アプリケーション生成トレイト
```

### テストの役割と責任

各テストディレクトリは以下の責任を持ちます：

#### Feature Tests
- アプリケーションの実際の機能や動作をエンドツーエンドでテストします
- HTTPリクエスト/レスポンスのフルスタックテストを行います
- ルート、コントローラー、ミドルウェア、レスポンスなど一連の流れをテストします

#### Unit Tests
- 単一のクラスや関数の振る舞いを分離してテストします
- モデル、リポジトリ、サービス、ユースケースなどの個別コンポーネントをテストします
- 依存関係はモックやスタブを用いて分離します

#### Integration Tests
- 複数のコンポーネントが連携して動作することをテストします
- 実際のデータベース接続やキャッシュを使用します
- 例：`tests/Integration/Services/Payment/PaymentServiceTest.php`

**実装のポイント：**
- 実環境に近い状態でのテストを心がける
- 外部サービスとの連携はモックを使用してシミュレート
- トランザクションを適切に使用してテスト間の影響を排除

#### Support
- テスト実行をサポートするヘルパークラスやトレイトを提供します
- テストデータの生成や共通のテストロジックを実装します

## テストの実装ルール

### 基本ルール

1. すべてのテストは独立して実行可能であること
2. テストは副作用を残さないこと（テスト実行後にデータベースがクリーンアップされること）
3. テストは可能な限り高速であること
4. 各テストは明確に1つの機能や条件をテストすること
5. テストケースは「準備（Arrange）」「実行（Act）」「検証（Assert）」の3ステップで構成すること

### ユースケーステスト

1. テストクラスでは `RefreshDatabase` トレイトを使用してデータベースをリセット
2. `setUp()` メソッドでテスト対象のユースケースクラスをインスタンス化
3. 各テストメソッドは特定の条件と結果をテスト
4. 正常系と異常系の両方をテスト

### リクエストバリデーションテスト

1. 共通のテストロジックは `AbstractRequestTest` クラスに実装
2. 各リクエストクラスは `validationRules` メソッドと `validationMessages` メソッドを実装
3. バリデーションの成功ケースと失敗ケースを網羅的にテスト
4. データプロバイダーを使用して複数のケースを効率的にテスト

## テストの実行方法

### 全テストの実行

```bash
cd src
php artisan test
```

### 特定のテストの実行

```bash
# 特定のテストファイルの実行
php artisan test tests/Unit/UseCases/Auth/AuthUser/ShowUseCaseTest.php

# 特定のテストグループの実行
php artisan test --testsuite=Unit
php artisan test --testsuite=Feature
php artisan test --testsuite=Integration
```

### フィルタリング

```bash
# 特定の名前を含むテストのみ実行
php artisan test --filter=test_can_register

# 特定のグループのテストのみ実行（アノテーション使用時）
php artisan test --group=auth

# 並列実行（PHP 8.0以降）
php artisan test --parallel

# カバレッジレポートの生成（XDebug必須）
XDEBUG_MODE=coverage php artisan test --coverage
```

### テストカバレッジの監視

テストカバレッジを監視するために、Codecovを使用しています。プルリクエスト時にカバレッジレポートが生成され、カバレッジが一定の閾値を下回る場合は警告が表示されます。

#### カバレッジ目標
- 機能（Feature）テスト: 最低80%
- ユニット（Unit）テスト: 最低90%
- 全体: 最低85%
